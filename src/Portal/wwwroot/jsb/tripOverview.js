var Trip;!function(e){var t=function(){function e(){this.rootCont=".scheduler",this.itemCont=".block",this.initResize()}return e.prototype.getLast=function(e){for(var t,i=!0,r=e;i;){var a=r+1,n=$(this.rootCont+" "+this.itemCont+'[data-no="'+r+'"]'),o=$(this.rootCont+" "+this.itemCont+'[data-no="'+a+'"]'),s=o.length>0;if(s){var l=n.offset().top,c=o.offset().top;c>l&&(t=n,i=!1)}else t=n,i=!1;r++}return t},e.prototype.initResize=function(){var e=this;$(window).resize(function(){e.onBeforeResize&&e.onBeforeResize(),e.timeout&&window.clearTimeout(e.timeout),e.timeout=setTimeout(function(){e.onAfterResize&&e.onAfterResize()},300)})},e}();e.TripResizer=t}(Trip||(Trip={}));var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},Views;!function(e){var t=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.initialize=function(t){var i=this;this.createFilesConfig(),this.getTrip(t),$("#commentSubmit").click(function(){i.comments.postComment(i.trip.tripId)}),this.tripMenu=new e.TripMenu},i.prototype.createFilesConfig=function(){var e=new Trip.FilesConfig;e.containerId="filesContainer",e.inputId="fileInput",e.editable=!1,e.addAdder=!0,e.templateId="fileView-template",this.files=new Trip.TripFiles(e)},i.prototype.registerPhotoUpload=function(){var e=this,t=new Common.FileUploadConfig;t.inputId="photoInput",t.endpoint="TripPhoto",t.maxFileSize=75e5,t.useMaxSizeValidation=!1,this.pictureUpload=new Common.FileUpload(t),this.pictureUpload.customId=this.trip.tripId,this.pictureUpload.onProgressChanged=function(e){var t=$("#progressBarTit");t.show();var i=e+"%";$(".progress").css("width",i),t.find("span").text(i)},this.pictureUpload.onUploadFinished=function(t,i){e.refreshBackground(e.trip.tripId);var r=$("#progressBarTit");r.hide()}},i.prototype.refreshBackground=function(e){$("#bckPhoto").css("background",""),$("#bckPhoto").css("background","transparent url('../../Trip/TripPicture/"+e+"') center top no-repeat")},i.prototype.getTrip=function(e){var i=this,r=[["id",e]];t.prototype.apiGet.call(this,"trip",r,function(e){return i.onTripLoaded(e)})},i.prototype.setFilesCustomConfig=function(e){var t=new Common.TripFileCustom;t.tripId=e,this.files.fileUpload.customConfig=t},i.prototype.initAcceptCombo=function(){var t=this.trip.ownerId===e.ViewBase.currentUserId;if(!t){var i=_.find(this.trip.participants,function(t){return t.userId===e.ViewBase.currentUserId}),r=null!=i;if(r){var a={comboId:"invitationState",initialState:i.state,tripId:this.trip.tripId};this.acceptCombo=new Trip.AcceptCombo(a),$("#invitationState").show()}}},i.prototype.onTripLoaded=function(e){this.trip=e,this.initAcceptCombo(),this.files.setFiles(this.trip.files,this.trip.tripId,this.trip.filesPublic),this.comments=new Trip.Comments,this.comments.comments=this.trip.comments,this.comments.users=this.trip.users,this.comments.displayComments(),this.planner=new Trip.Planner(this.trip,!1),this.registerPhotoUpload()},i}(e.ViewBase);e.TripViewView=t}(Views||(Views={}));var Views;!function(e){var t=function(){function t(){this.$win=$("#menuItemContent"),this.$container=this.$win.find(".cont"),this.registerEvents(),this.registerTemplates()}return t.prototype.registerTemplates=function(){this.privacyTemplate=e.ViewBase.currentView.registerTemplate("menuPrivacy-template"),this.shareTemplate=e.ViewBase.currentView.registerTemplate("menuShare-template"),this.participantsTemplate=e.ViewBase.currentView.registerTemplate("participants-template"),this.participantTemplate=e.ViewBase.currentView.registerTemplate("participant-template")},t.prototype.setCode=function(e){var t="";e&&(t="http://gloobster/"+e),$("#sharingCode").val(t)},t.prototype.createPrivacyContent=function(t){var i=$(this.privacyTemplate());i.find("#friendsPublic").prop("checked",t.friendsPublic),i.find("#allowRequestJoin").prop("checked",t.allowToRequestJoin),i.find("#friendsPublic").change(function(i){var r=$(i.target).prop("checked"),a={propertyName:"FriendsPublic",values:{id:t.tripId,state:r}};e.ViewBase.currentView.apiPut("tripProperty",a,function(){t.friendsPublic=r})}),i.find("#allowRequestJoin").change(function(i){var r=$(i.target).prop("checked"),a={propertyName:"AllowToRequestJoin",values:{id:t.tripId,state:r}};e.ViewBase.currentView.apiPut("tripProperty",a,function(){t.allowToRequestJoin=r})}),this.$container.html(i)},t.prototype.fillSocStr=function(e,t){t.find("#share").find("span").html(e)},t.prototype.createShareContent=function(){var t=this,i=$(this.shareTemplate()),r=new Common.ShareButtons(i.find("#shareCont"));r.onSelectionChanged=function(e){t.fillSocStr(e,i)},this.fillSocStr(r.getStr(),i),i.find("#share").click(function(){var i=r.getSelectedNetworks(),a={message:$("#message").val(),tripId:e.ViewBase.currentView.trip.tripId,networks:i};t.$win.hide();var n=e.ViewBase.currentView,o=new Common.InprogressDialog;o.create(n.t("SharingTrip","jsTrip"),t.$win);var s=new Common.HintDialog;e.ViewBase.currentView.apiPost("TripSocNetworks",a,function(e){o.remove();var t=""===e;t?s.create(n.t("TripShared","jsTrip")):"HasUnnamed"===e&&s.create(n.t("CannotShareUnnamed","jsTrip"))})}),this.$container.html(i)},t.prototype.createParticipantsContent=function(e){var t=this,i=this.participantsTemplate();this.$container.html(i),e.participants.forEach(function(e){t.generateOneParticipant(e.name,e.userId,e.isAdmin,e.state)});var r=new Common.UserSearchConfig;r.elementId="friends",r.clearAfterSearch=!0,r.endpoint="FriendsSearch",this.userSearchBox=new Common.UserSearchBox(r),this.userSearchBox.onUserSelected=function(i){t.addUser(e,i)}},t.prototype.isAreadyAdded=function(e,t){var i=_.find(e.participants,function(e){return e.id===t});return null!=i},t.prototype.addUser=function(t,i){var r=this,a=i.friendId,n=this.isAreadyAdded(t,a);if(!n){var o={caption:$("#caption").val(),tripId:t.tripId,users:[a]};e.ViewBase.currentView.apiPost("TripParticipants",o,function(e){r.addOneParticipant(i.displayName,a)})}},t.prototype.generateOneParticipant=function(t,i,r,a){var n=e.ViewBase.currentView.trip,o={name:t,id:i,checked:r?"checked":"",state:this.getTextState(a)},s=$("#participantsTable"),l=$(this.participantTemplate(o));l.find(".delete").click(function(t){var i=$(t.target),r=i.data("id"),a=[["tripId",n.tripId],["id",r]];e.ViewBase.currentView.apiDelete("TripParticipants",a,function(e){s.find("#"+r).remove(),s.find("#line_"+r).remove(),n.participants=_.reject(n.participants,function(e){return e.userId===r})})}),l.find(".isAdmin").click(function(t){var i=$(t.target),r=i.data("id"),a=i.prop("checked"),o={tripId:n.tripId,id:r,isAdmin:a};e.ViewBase.currentView.apiPut("TripParticipantsIsAdmin",o,function(e){var t=_.find(n.participants,function(e){return e.userId===r});t.isAdmin=a})}),s.prepend(l)},t.prototype.getTextState=function(t){var i=e.ViewBase.currentView;return t===ParticipantState.Invited?i.t("Invited","jsTrip"):t===ParticipantState.Accepted?i.t("Accepted","jsTrip"):t===ParticipantState.Maybe?i.t("Maybe","jsTrip"):t===ParticipantState.Refused?i.t("Refused","jsTrip"):void 0},t.prototype.addOneParticipant=function(t,i){this.generateOneParticipant(t,i,!1,0);var r=e.ViewBase.currentView.trip,a={isAdmin:!1,name:t,state:0,userId:i};r.participants.push(a)},t.prototype.registerEvents=function(){var e=this,t=$(".menu-btn");t.click(function(i){var r=$(i.target).closest(".menu-btn");t.removeClass("active"),r.addClass("active");var a=r.data("t");e.displayContent(a)}),this.$win.find(".close").click(function(t){t.preventDefault(),e.$win.slideUp()})},t.prototype.displayContent=function(t){this.$win.slideDown();var i=e.ViewBase.currentView.trip;"menuPrivacy-template"===t&&(this.setDialogInfo("PrivacySettings","PrivacyText"),this.createPrivacyContent(i)),"menuShare-template"===t&&(this.setDialogInfo("ShareTripTitle","ShareTripText"),this.createShareContent()),"participants-template"===t&&(this.setDialogInfo("ParticipTitle","ParticipText"),this.createParticipantsContent(i))},t.prototype.setDialogInfo=function(t,i){var r=$("#menuItemContent"),a=e.ViewBase.currentView,n=a.t(t,"jsTrip"),o=a.t(i,"jsTrip");r.find(".title").html(n),r.find(".txt").html(o)},t}();e.TripMenu=t}(Views||(Views={}));var Common;!function(e){var t=function(){function e(e){this.socNetworks=[{type:SocialNetworkType.Facebook,iconName:"facebook"},{type:SocialNetworkType.Twitter,iconName:"twitter"}],this.activeTag='<span class="icon-visited"></span>',this.$owner=e,this.createHtml()}return e.prototype.getSelectedNetworks=function(){var e=this,t=[];return this.$owner.find("div").toArray().forEach(function(i){var r=$(i);e.isActive(r)&&t.push(parseInt(r.data("t")))}),t},e.prototype.createHtml=function(){var e=this,t=!0;this.socNetworks.forEach(function(i){if(Views.ViewBase.currentView.hasSocNetwork(i.type)){var r=e.getItemHtml(t,!0,i.type);e.$owner.append(r),t=!1}})},e.prototype.getByType=function(e){return _.find(this.socNetworks,function(t){return t.type===e})},e.prototype.getItemHtml=function(e,t,i){var r=this,a=e?"":" mleft10",n=this.getByType(i),o=$('<div data-t="'+i+'" class="icon-holder minus"><img class="opacity5 middle'+a+'" src="../../images/share-'+n.iconName+'.png">'+this.activeTag+"</div>");return o.click(function(e){var t=r.isActive(o);if(t){var i=o.find(".icon-visited");i.remove()}else o.append(r.activeTag);if(r.onSelectionChanged){var a=r.getStr();r.onSelectionChanged(a)}}),o},e.prototype.getStr=function(){var e=this.getSelectedNetworks(),t=[];_.contains(e,0)&&t.push("Facebook"),_.contains(e,2)&&t.push("Twitter");var i="("+t.join()+")";return i},e.prototype.isActive=function(e){var t=e.find(".icon-visited");return 1===t.length},e}();e.NShareButtons=t;var i=function(){function e(e){this.socNetworks=[{type:SocialNetworkType.Facebook,iconName:"facebook"},{type:SocialNetworkType.Twitter,iconName:"twitter"}],this.activeTag='<span class="icon-visited"></span>',this.$owner=e,this.createHtml()}return e.prototype.getSelectedNetworks=function(){var e=this,t=[];return this.$owner.find("div").toArray().forEach(function(i){var r=$(i);e.isActive(r)&&t.push(parseInt(r.data("t")))}),t},e.prototype.createHtml=function(){var e=this,t=!0;this.socNetworks.forEach(function(i){if(Views.ViewBase.currentView.hasSocNetwork(i.type)){var r=e.getItemHtml(t,!0,i.type);e.$owner.append(r),t=!1}})},e.prototype.getByType=function(e){return _.find(this.socNetworks,function(t){return t.type===e})},e.prototype.getItemHtml=function(e,t,i){var r=this,a=e?"":" mleft10",n=this.getByType(i),o=$('<div data-t="'+i+'" class="icon-holder minus"><img class="opacity5 middle'+a+'" src="../../images/share-'+n.iconName+'.png">'+this.activeTag+"</div>");return o.click(function(e){var t=r.isActive(o);if(t){var i=o.find(".icon-visited");i.remove()}else o.append(r.activeTag);if(r.onSelectionChanged){var a=r.getStr();r.onSelectionChanged(a)}}),o},e.prototype.getStr=function(){var e=this.getSelectedNetworks(),t=[];_.contains(e,0)&&t.push("Facebook"),_.contains(e,2)&&t.push("Twitter");var i="("+t.join()+")";return i},e.prototype.isActive=function(e){var t=e.find(".icon-visited");return 1===t.length},e}();e.ShareButtons=i}(Common||(Common={}));var Trip;!function(e){var t=function(){function e(){var e=$("#comment-template").html();this.template=Handlebars.compile(e)}return e.prototype.generateComments=function(){var e=this,t="";return this.comments?(this.comments.forEach(function(i){t+=e.generateComment(i)}),t):""},e.prototype.postComment=function(e){var t=this,i=$("#commentInput"),r=i.val(),a={text:r,tripId:e};Views.ViewBase.currentView.apiPost("tripComment",a,function(e){t.comments=e.comments,t.users=e.users,t.displayComments()}),i.val("")},e.prototype.displayComments=function(){var e=this.generateComments();$("#commentsContainer").html(e)},e.prototype.generateComment=function(e){var t=this.addUserData(e),i=this.template(t);return i},e.prototype.addUserData=function(e){var t=this.getUserById(e.userId),i=Views.ViewBase.currentView.t("Anonymous","jsLayout"),r="/PortalUser/ProfilePicture_s/"+t.id;t&&(i=t.displayName,e.id=t.id);var a=new Date(e.postDate);return e.displayDate=a.getDate()+"."+a.getMonth()+"."+a.getFullYear()+" ("+a.getHours()+":"+a.getMinutes()+")",e.displayName=i,e.photoUrl=r,e},e.prototype.getUserById=function(e){var t=_.find(this.users,function(t){return t.id===e});return t},e}();e.Comments=t}(Trip||(Trip={}));var Trip;!function(e){var t=function(){function e(){}return e}();e.FilesConfig=t;var i=function(){function e(t,i){var r=this;void 0===i&&(i=null),t.adderTemplate&&(this.fileInputTemplate=Views.ViewBase.currentView.registerTemplate(t.adderTemplate)),this.fileDocumentTemplate=Views.ViewBase.currentView.registerTemplate(t.templateId),t.isMasterFile&&(e.masterFiles=this),this.config=t,this.$mainContainer=$("#"+t.mainContainerId),this.$container=$("#"+t.containerId);var a=$("#deleteFileConfirm");a.unbind(),a.click(function(){r.callDelete(e.lastIdToDelete),$("#popup-delete").hide()}),this.config.editable&&this.registerFileUpload(i),this.v=Views.ViewBase.currentView}return e.prototype.registerFileUpload=function(e){var t=this,i=new Common.FileUploadConfig;i.inputId=this.config.inputId,i.endpoint="TripFile",i.customInputRegistration=!0,this.fileUpload=new Common.FileUpload(i,e),this.fileUpload.onProgressChanged=function(e){t.$mainContainer.find(".upload-droparea").show(),t.$mainContainer.find(".upload-progressbar").show();var i=t.$mainContainer.find(".upload-progressbar");i.show(),t.setUploadProgress(e)},this.fileUpload.onUploadFinished=function(e,i){t.$mainContainer.find(".upload-droparea").hide(),t.$mainContainer.find(".upload-progressbar").hide(),t.setUploadProgress(0),i&&t.filterFiles(i.files,i.filesPublic)}},e.prototype.addAdder=function(){var e=this;this.$adder=$(this.fileInputTemplate({id:this.config.inputId})),this.fileDaD=new Common.FileDaD,this.$container.append(this.$adder),this.fileUpload.$filesInput=this.$adder.find("#"+this.config.inputId),this.fileDaD.onFiles=function(t){e.fileUpload.filesEvent(t)},this.fileDaD.registerComponent(this.config.mainContainerId)},e.prototype.setFiles=function(e,t,i){this.filesPublic=i,this.files=e,this.tripId=t,this.onFilesSet()},e.prototype.onFilesSet=function(){this.generateFiles()},e.prototype.callDelete=function(e){var t=this,i=[["fileId",e],["tripId",this.tripId]];this.v.apiDelete("tripFile",i,function(e){t.filterFiles(e.files,e.filesPublic)})},e.prototype.filterFiles=function(t,i){var r=this;if(t){if(this.filesPublic=i,this.config.entityId){var a=_.filter(t,function(e){return e.entityId===r.config.entityId});this.files=a,this.generateFiles()}else this.files=t,this.generateFiles();e.masterFiles&&!this.config.isMasterFile&&(e.masterFiles.files=t,e.masterFiles.filesPublic=i,e.masterFiles.generateFiles())}},e.prototype.generateFiles=function(){var e=this;this.$container.children().not(this.$adder).remove(),this.files&&this.files.length>0&&($(".fileDocs").show(),this.files.forEach(function(t){var i=t.ownerId===Views.ViewBase.currentUserId,r=e.getFilePublic(t.id),a=i||r.isPublic;if(a){var n={fileName:e.getShortFileName(t.originalFileName),id:t.id,fileType:e.getFileType(t.originalFileName),tripId:e.tripId,editable:e.config.editable,isOwner:i,canManipulate:e.config.editable&&i},o=e.generateFile(n);e.$container.prepend(o)}}),this.$container.find(".delete").click(function(t){t.preventDefault();var i=$(t.target).closest(".delete"),r=i.data("id"),a=new Common.ConfirmDialog;a.create(e.v.t("DelDialogTitle","jsTrip"),e.v.t("DelDialogBody","jsTrip"),e.v.t("Cancel","jsLayout"),e.v.t("Ok","jsLayout"),function(){e.callDelete(r)})})),this.config.editable&&this.config.addAdder&&!this.$adder&&this.addAdder()},e.prototype.generateFile=function(e){var t=this,i=this.getFilePublic(e.id),r=this.fileDocumentTemplate(e),a=$(r),n=a.find(".filePublic");return n.prop("checked",i.isPublic),this.config.editable&&n.change(function(e){var i=$(e.target),r=i.data("id"),a=i.prop("checked"),n={fileId:r,tripId:t.tripId,state:a};Views.ViewBase.currentView.apiPut("tripFilePublic",n,function(e){var t=$(".filePublic"+r);t.prop("checked",a)})}),a},e.prototype.getFilePublic=function(e){var t=_.find(this.filesPublic,function(t){return t.fileId===e});return t},e.prototype.getFileType=function(e){var t=e.split("."),i=t[t.length-1];if(_.contains(["jpg","jpeg","bmp","png","gif"],i))return"img";if(_.contains(["docx","doc"],i))return"doc";var r=["doc","docx","xml","html","pdf","txt","jpg","jpeg","bmp","png","gif"],a=_.contains(r,i);return a?i:"txt"},e.prototype.getShortFileName=function(e){if(e.length<=13)return e;var t=0,i="";return e.split("").forEach(function(e){i.length>24||(t++,i+=e,10===t&&(i+="-",t=0))}),i},e.prototype.setUploadProgress=function(e){var t=this.$mainContainer.find(".upload-progressbar");t.find(".progress").css("width",e+"%"),t.find("span").text(e+"%")},e}();e.TripFiles=i}(Trip||(Trip={}));var Trip;!function(e){var t=function(){function e(){}return e}();e.AcceptComboConfig=t;var i=function(){function e(e){var t=this;this.config=e,this.$combo=$("#"+e.comboId),this.$ul=this.$combo.find("ul"),this.$selected=this.$combo.find(".selected"),this.$input=this.$combo.find("input"),this.initState(e.initialState),this.$input.change(function(e){return t.onChange(e)})}return e.prototype.onChange=function(e){var t=this.$input.val(),i={tripId:this.config.tripId,newState:parseInt(t)};Views.ViewBase.currentView.apiPut("TripInvitationState",i,function(e){})},e.prototype.initState=function(e){this.setHtmlContByState(e)},e.prototype.setHtmlContByState=function(e){var t=this.$ul.find('li[data-value="'+e+'"]');this.$selected.html(t.html())},e}();e.AcceptCombo=i}(Trip||(Trip={}));var Trip;!function(e){var t=function(){function t(t,i){this.$currentContainer=$("#dataCont"),this.emptyName=Views.ViewBase.currentView.t("Unnamed","jsTrip"),this.inverseColor=!1;var r=_.find(t.participants,function(e){return e.userId===Views.ViewBase.currentUserId});this.isInvited=null!=r,this.isOwner=t.ownerId===Views.ViewBase.currentUserId,this.editable=i,this.dialogManager=new e.DialogManager(this),this.placeDialog=new e.PlaceDialog(this.dialogManager),this.travelDialog=new e.TravelDialog(this.dialogManager),this.trip=t,this.registerTemplates(),this.placesMgr=new e.PlacesManager(t.id),this.placesMgr.setData(t.travels,t.places),this.redrawAll(),this.initResizer()}return t.prototype.initResizer=function(){var t=this;this.resizer=new e.TripResizer,this.resizer.onBeforeResize=function(){var e=$(".details");e.length>0&&e.hide()},this.resizer.onAfterResize=function(){var e=$(".details");e.length>0&&(t.$lastBlockOnRow=t.resizer.getLast(t.$activeBlock.data("no")),t.$lastBlockOnRow.after(e),e.slideDown())}},t.prototype.redrawAll=function(){var e=this,t=_.sortBy(this.placesMgr.places,"orderNo"),i=0;t.forEach(function(t){if(i++,e.addPlace(t,e.inverseColor),t.leaving){var r=t.leaving;e.addTravel(r,e.inverseColor)}e.inverseColor=!e.inverseColor}),this.editable&&this.addAdder()},t.prototype.addAdder=function(){var e=this,t=this.addPlaceTemplate();this.$currentContainer.append(t),this.$adder=$("#addPlace"),this.$lastCell=$("#lastCell"),this.$adder.click(function(t){t.preventDefault(),e.addEnd()})},t.prototype.refreshAdder=function(){this.$lastCell.remove(),this.addAdder()},t.prototype.registerTemplates=function(){this.addPlaceTemplate=Views.ViewBase.currentView.registerTemplate("addPlace-template"),this.travelTemplate=Views.ViewBase.currentView.registerTemplate("travel-template"),this.placeTemplate=Views.ViewBase.currentView.registerTemplate("place-template")},t.prototype.addEnd=function(){var e=this;this.dialogManager.closeDialog(),this.dialogManager.deactivate();var t=this.placesMgr.getLastPlace(),i={selectorId:t.id,position:NewPlacePosition.ToRight,tripId:this.trip.tripId};Views.ViewBase.currentView.apiPost("tripPlanner",i,function(i){var r=e.placesMgr.mapTravel(i.travel,t,null);t.leaving=r,e.placesMgr.travels.push(r);var a=e.placesMgr.mapPlace(i.place,r,null);r.to=a,e.placesMgr.places.push(a),e.updateRibbonDate(t.id,"leavingDate",r.leavingDateTime),e.addTravel(r,!e.inverseColor),e.addPlace(a,e.inverseColor),e.inverseColor=!e.inverseColor,e.dialogManager.selectedId=i.place.id})},t.prototype.updateRibbonDate=function(e,t,i){$("#"+e).find("."+t).text(this.formatShortDateTime(i))},t.prototype.getTravelIcon=function(e){switch(e){case TravelType.Bus:return"icon-car";case TravelType.Car:return"icon-car";case TravelType.Plane:return"icon-plane";case TravelType.Ship:return"icon-boat";case TravelType.Walk:return"icon-walk";case TravelType.Bike:return"icon-bike";case TravelType.Train:return"icon-train";default:return""}},t.prototype.regDateLinks=function(e){var t=this;e.find(".dateLink").click(function(e){e.preventDefault();var i=$(e.target),r=i.closest(".placeCont").attr("id");t.setActivePlaceOrTravel(r)})},t.prototype.appendToTimeline=function(e){this.$adder?this.$lastCell.before(e):this.$currentContainer.append(e)},t.prototype.activeBlockChanged=function(e){this.$activeBlock=e,this.$lastBlockOnRow=this.resizer.getLast(e.data("no")),this.dialogManager.$lastBlockOnRow=this.$lastBlockOnRow},t.prototype.setActivePlaceOrTravel=function(e){this.activeBlockChanged(e);var t=e.attr("id");this.dialogManager.deactivate();var i,r,a=$("#"+t),n=a.hasClass("placeCont"),o='<span class="tab"></span>';n?(r=this.placeDialog,i=a.find(".destination"),a.find(".tab-cont").html(o)):(r=this.travelDialog,i=a.find(".transport"),i.append(o)),i.addClass("active"),this.dialogManager.selectedId=t,r.display()},t.prototype.getHighestBlockNo=function(){var e=0;return this.$currentContainer.find(".block").toArray().forEach(function(t){var i=$(t),r=i.data("no");r&&r>e&&(e=r)}),e},t.prototype.addPlace=function(e,t){var i=this,r=this.emptyName;e.place&&(r=e.place.selectedName);var a={id:e.id,isActive:!1,name:r,arrivingDate:"",leavingDate:"",arrivalDateLong:"",isFirstDay:null==e.arriving,colorClassArriving:"",colorClassLeaving:"",arrivingId:"",leavingId:"",no:this.getHighestBlockNo()+1};if(null!=e.arriving){var n=e.arriving.arrivingDateTime;a.arrivingDate=this.formatShortDateTime(n),a.arrivalDateLong=this.formatShortDateTime(n)+(""+n.getUTCFullYear()),a.arrivingId=e.arriving.id}if(null!=e.leaving){var o=e.leaving.leavingDateTime;a.leavingDate=this.formatShortDateTime(o),a.leavingId=e.leaving.id}t?(a.colorClassArriving="green",a.colorClassLeaving=""):(a.colorClassArriving="",a.colorClassLeaving="green");var s=this.placeTemplate(a),l=$(s);return this.regDateLinks(l),l.find(".destination").click("*",function(e){var t=$(e.delegateTarget),r=t.closest(".block");i.setActivePlaceOrTravel(r)}),this.appendToTimeline(l),l},t.prototype.addTravel=function(e,t){var i=this,r={id:e.id,icon:this.getTravelIcon(e.type),colorClass:"",no:this.getHighestBlockNo()+1};t?r.colorClass="":r.colorClass="green";var a=this.travelTemplate(r),n=$(a);return n.find(".transport").click("*",function(e){var t=$(e.delegateTarget),r=t.closest(".block");i.setActivePlaceOrTravel(r)}),this.appendToTimeline(n),n},t.prototype.formatShortDateTime=function(e){var t=moment.utc(e).format("l"),i=t.replace(e.getUTCFullYear(),"");return i},t}();e.Planner=t}(Trip||(Trip={}));var Trip;!function(e){var t=function(){function t(e){this.planner=e,this.placeDetailTemplate=Views.ViewBase.currentView.registerTemplate("placeDetail-template"),this.placeDetailViewTemplate=Views.ViewBase.currentView.registerTemplate("placeDetailView-template"),this.travelDetailTemplate=Views.ViewBase.currentView.registerTemplate("travelDetail-template"),this.travelDetailViewTemplate=Views.ViewBase.currentView.registerTemplate("travelDetailView-template"),this.visitedItemTemplate=Views.ViewBase.currentView.registerTemplate("visitItem-template"),this.travelDetailViewFriends=Views.ViewBase.currentView.registerTemplate("travelDetailViewFriends-template"),this.placeDetailViewFriends=Views.ViewBase.currentView.registerTemplate("placeDetailViewFriends-template")}return t.prototype.insertDialog=function(e){var t=$(".details");t.remove(),this.$lastBlockOnRow.after(e)},t.prototype.createFilesInstanceView=function(t,i){var r=new e.FilesConfig;r.containerId="entityDocs",r.templateId="fileView-template",r.editable=!1,r.addAdder=!1,r.entityId=t;var a=new e.TripFiles(r);return a},t.prototype.createFilesInstance=function(t,i){var r=new e.FilesConfig;r.mainContainerId="dialogUpload",r.containerId="entityDocs",r.inputId="entityFileInput",r.templateId="fileItem-template",r.editable=!0,r.addAdder=!0,r.adderTemplate="fileCreate-template",r.entityId=t;var a=new Common.TripFileCustom;a.tripId=this.planner.trip.tripId,a.entityId=t,a.entityType=i;var n=new e.TripFiles(r,a);return n},t.prototype.initDescription=function(e,t){var i=this;$("#dialogDescription").val(e);var r=new Common.DelayedCallback("dialogDescription");r.callback=function(e){var r=i.getPropRequest("description",{entityType:t,description:e});i.updateProp(r,function(e){})}},t.prototype.getDialogData=function(e,t){var i=[["dialogType",e],["tripId",this.planner.trip.tripId],["id",this.selectedId]];Views.ViewBase.currentView.apiGet("TripPlannerProperty",i,function(e){t(e)})},t.prototype.closeDialog=function(){$(".details").remove()},t.prototype.regClose=function(e){var t=this;e.find(".close").click(function(e){e.preventDefault(),t.closeDialog(),t.deactivate()})},t.prototype.deactivate=function(){var e=$(".destination.active");e.removeClass("active"),e.closest(".placeCont").find(".tab-cont").empty();var t=$(".transport.active");t.removeClass("active"),t.find(".tab").remove()},t.prototype.getPropRequest=function(e,t){var i={propertyName:e,values:{tripId:this.planner.trip.tripId,entityId:this.selectedId}};return i.values=$.extend(i.values,t),i},t.prototype.updateProp=function(e,t){Views.ViewBase.currentView.apiPut("tripPlannerProperty",e,function(e){return t(e)})},t}();e.DialogManager=t}(Trip||(Trip={}));var Trip;!function(e){var t=function(){function t(e){this.dialogManager=e}return t.prototype.display=function(){var e=this;this.dialogManager.getDialogData(TripEntityType.Place,function(t){e.dialogManager.planner.editable?e.createEdit(t):e.createView(t)})},t.prototype.createView=function(e){this.buildTemplateView(e),this.files=this.dialogManager.createFilesInstanceView(e.id,TripEntityType.Place),this.files.setFiles(e.files,this.dialogManager.planner.trip.tripId,e.filesPublic)},t.prototype.createEdit=function(e){var t=this;this.buildTemplateEdit(e),this.createNameSearch(e),$("#stayAddress").val(e.addressText),this.createAddressSearch(e),this.regAddressText(),this.createPlaceToVisitSearch(e),this.dialogManager.initDescription(e.description,TripEntityType.Place),e.wantVisit&&e.wantVisit.forEach(function(e){t.addPlaceToVisit(e.id,e.selectedName,e.sourceType,e.sourceId)}),this.files=this.dialogManager.createFilesInstance(e.id,TripEntityType.Place),this.files.setFiles(e.files,this.dialogManager.planner.trip.tripId,e.filesPublic)},t.prototype.createNameSearch=function(e){var t=this,i=new Common.PlaceSearchConfig;i.providers="0,1,2,3,4",i.elementId="cities",i.minCharsToSearch=1,i.clearAfterSearch=!1,i.customSelectedFormat=function(e){return t.placeNameCustom(e)},this.placeSearch=new Common.PlaceSearchBox(i),this.placeSearch.onPlaceSelected=function(e,i){return t.onPlaceSelected(e,i)},e.place&&this.placeSearch.setText(e.place.selectedName)},t.prototype.placeNameCustom=function(e){var t="",i=_.contains([SourceType.FB,SourceType.S4,SourceType.Yelp],e.SourceType);return i&&(t=""+this.takeMaxChars(e.Name,19)),e.SourceType===SourceType.Country&&(t=e.CountryCode),e.SourceType===SourceType.City&&(t=this.takeMaxChars(e.City,19)+", "+e.CountryCode),t},t.prototype.takeMaxChars=function(e,t){return e.length<=t?e:e.substring(0,t-1)+"."},t.prototype.createPlaceToVisitSearch=function(e){var t=this,i=new Common.PlaceSearchConfig;i.providers="1,0,4",i.elementId="placeToVisit",i.minCharsToSearch=1,i.clearAfterSearch=!0,this.placeToVisitSearch=new Common.PlaceSearchBox(i),this.placeToVisitSearch.onPlaceSelected=function(e,i){return t.onPlaceToVisitSelected(e,i)},e.place&&e.place.coordinates&&this.placeToVisitSearch.setCoordinates(e.place.coordinates.Lat,e.place.coordinates.Lng)},t.prototype.createAddressSearch=function(e){var t=this,i=new Common.PlaceSearchConfig;i.providers="1,0,4",i.elementId="stayPlace",i.minCharsToSearch=1,i.clearAfterSearch=!1,i.customSelectedFormat=function(e){return e.Name},this.addressSearch=new Common.PlaceSearchBox(i),this.addressSearch.onPlaceSelected=function(e,i){return t.onAddressSelected(e,i)};var r="";e.address&&(r=e.address.selectedName),this.addressSearch.setText(r),e.place&&e.place.coordinates&&this.addressSearch.setCoordinates(e.place.coordinates.Lat,e.place.coordinates.Lng)},t.prototype.regAddressText=function(){var e=this,t=new Common.DelayedCallback("stayAddress");t.callback=function(t){var i=e.dialogManager.getPropRequest("addressText",{text:t});e.dialogManager.updateProp(i,function(e){})}},t.prototype.buildTemplateView=function(e){var t=this,i="",r={name:Views.ViewBase.currentView.t("Unnamed","jsTrip"),wantVisit:[],hasNoWantVisit:!0};if(r.wantVisit=_.map(e.wantVisit,function(e){return{name:e.selectedName,icon:t.getIcon(e.sourceType),link:t.getSocLink(e.sourceType,e.sourceId)}}),r.hasNoWantVisit=0===r.wantVisit.length,e.place&&(r.name=e.place.selectedName),this.dialogManager.planner.isInvited||this.dialogManager.planner.isOwner){var a="";e.address&&(a=e.address.selectedName),r=$.extend(r,{stayAddress:e.addressText,description:e.description,stayName:a}),e.address&&(r=$.extend(r,{stayIco:this.getIcon(e.address.sourceType),stayLink:this.getSocLink(e.address.sourceType,e.address.sourceId),hasAddress:!0})),i=this.dialogManager.placeDetailViewTemplate(r)}else i=this.dialogManager.placeDetailViewFriends(r);var n=$(i);this.dialogManager.regClose(n),this.dialogManager.insertDialog(n)},t.prototype.getSocLink=function(e,t){var i="";return e===SourceType.FB&&(i="http://facebook.com/"+t),e===SourceType.S4&&(i="http://foursquare.com/v/"+t),e===SourceType.Yelp&&(i="http://www.yelp.com/biz/"+t),i},t.prototype.buildTemplateEdit=function(t){var i=this,r={showDelButton:t.isLastPlace&&t.placesCount>2},a=$(this.dialogManager.placeDetailTemplate(r)),n=new e.PlaceTravelTime(this.dialogManager,t),o=n.create(TripEntityType.Place);a.find(".the-first").after(o),a.find(".delete").click(function(e){e.preventDefault();var r=Views.ViewBase.currentView,a=new Common.ConfirmDialog;a.create(r.t("PlaceRemovelDialogTitle","jsTrip"),r.t("PlaceRemovelDialogBody","jsTrip"),r.t("Cancel","jsLayout"),r.t("Delete","jsLayout"),function(){Views.ViewBase.currentView.apiDelete("TripPlanner",[["tripId",t.tripId]],function(e){i.deletePlace(e.placeId,e.travelId)})})}),this.dialogManager.regClose(a),this.dialogManager.insertDialog(a)},t.prototype.deletePlace=function(e,t){$("#"+e).remove(),$("#"+t).remove(),this.dialogManager.closeDialog();var i=this.dialogManager.planner.placesMgr;i.removePlaceById(e),i.removeTravelById(t)},t.prototype.onPlaceToVisitSelected=function(e,t){var i=this,r=this.dialogManager.getPropRequest("placeToVisit",{sourceId:e.SourceId,sourceType:e.SourceType,selectedName:t.Name});this.dialogManager.updateProp(r,function(r){var a=r.Result;i.addPlaceToVisit(a,t.Name,e.SourceType,e.SourceId)})},t.prototype.onAddressSelected=function(e,t){$("#stayAddress").val(t.Address);var i=this.dialogManager.getPropRequest("address",{sourceId:e.SourceId,sourceType:e.SourceType,selectedName:t.Name,address:t.Address,lat:t.Coordinates.Lat,lng:t.Coordinates.Lng});this.dialogManager.updateProp(i,function(e){})},t.prototype.onPlaceSelected=function(e,t){$(".active .name").text(this.placeSearch.lastText);var i=this.dialogManager.getPropRequest("place",{sourceId:e.SourceId,sourceType:e.SourceType,selectedName:this.placeSearch.lastText}),r=t.Coordinates;r&&(this.addressSearch.setCoordinates(r.Lat,r.Lng),this.placeToVisitSearch.setCoordinates(r.Lat,r.Lng),i.values.lat=r.Lat,i.values.lng=r.Lng),this.dialogManager.updateProp(i,function(e){})},t.prototype.addPlaceToVisit=function(e,t,i,r){var a=this,n=this.getIcon(i),o={
id:e,icon:n,name:this.takeMaxChars(t,33),link:this.getSocLink(i,r)},s=this.dialogManager.visitedItemTemplate(o),l=$(s);l.find(".delete").click(function(e){e.preventDefault();var t=$(e.target),i=a.dialogManager.getPropRequest("placeToVisitRemove",{id:t.closest(".place").data("id")});a.dialogManager.updateProp(i,function(e){}),l.remove()}),$("#placeToVisit").before(l)},t.prototype.getIcon=function(e){switch(e){case SourceType.FB:return"icon-facebook";case SourceType.S4:return"icon-foursquare";case SourceType.Yelp:return"icon-yelp"}return""},t}();e.PlaceDialog=t}(Trip||(Trip={}));var Trip;!function(e){var t=function(){function e(){this.clearAfterSelection=!1}return e}();e.AirportComboConfig=t;var i=function(){function e(e,i){void 0===i&&(i=new t),this.limit=8,this.config=i,this.$combo=$("#"+e),this.$cont=this.$combo.find("ul"),this.$input=this.$combo.find("input"),this.registerInput(),this.registerInOut()}return e.prototype.setText=function(e){this.lastText=e,this.$input.val(e)},e.prototype.registerInOut=function(){var e=this;this.$input.focus(function(e){$(e.target).val("")}),this.$input.focusout(function(){e.setText(e.lastText)})},e.prototype.registerInput=function(){var e=this,t=new Common.DelayedCallback(this.$input);t.callback=function(t){var i=[["query",t],["limit",e.limit]];Views.ViewBase.currentView.apiGet("airport",i,function(t){return e.onResult(t)})}},e.prototype.onResult=function(e){this.displayResults(e)},e.prototype.displayResults=function(e){var t=this;return this.$cont.html(""),e?(this.$cont.show(),e.forEach(function(e){var i=t.getItemHtml(e);t.$cont.append(i)}),void this.registerClick()):void this.$cont.hide()},e.prototype.registerClick=function(){var e=this;this.$cont.find("li").click(function(t){var i=$(t.target);e.onClick(i)})},e.prototype.onClick=function(e){var t=e.data("value"),i=e.data("id");this.config.clearAfterSelection?this.$input.val(""):this.$input.val(t),this.$cont.html("");var r={id:i,name:t};this.onSelected(r)},e.prototype.getItemHtml=function(e){var t=e.iataFaa;""===t&&(t=e.icao);var i=e.name+" ("+e.city+")",r=e.city+" ("+t+")";return'<li data-value="'+r+'" data-id="'+e.id+'">'+i+" - "+t+"</li>"},e}();e.AirportCombo=i}(Trip||(Trip={}));var Trip;!function(e){var t=function(){function t(e){this.dialogManager=e}return t.prototype.display=function(){var e=this;this.dialogManager.getDialogData(TripEntityType.Travel,function(t){e.data=t,e.dialogManager.planner.editable?e.createEdit(t):e.createView(t)})},t.prototype.createView=function(e){this.buildTemplateView(e),this.files=this.dialogManager.createFilesInstanceView(e.id,TripEntityType.Travel),this.files.setFiles(e.files,this.dialogManager.planner.trip.tripId,e.filesPublic)},t.prototype.extendContextForFlight=function(e,t){e.isFlight=!0;var i={from:"",to:"",flightDetails:"-"};t.flightFrom&&(i.from=t.flightFrom.selectedName),t.flightTo&&(i.to=t.flightTo.selectedName);var r=$.extend(e,i);return r},t.prototype.formatDate=function(e,t){var i=t?"LLL":"LL",r=moment.utc(e).format(i);return r},t.prototype.buildTemplateView=function(e){var t="",i=new Date(e.leavingDateTime),r=new Date(e.arrivingDateTime);if(this.dialogManager.planner.isInvited||this.dialogManager.planner.isOwner){var a={arrivingDateTime:this.formatDate(i,e.useTime),leavingDateTime:this.formatDate(r,e.useTime),description:e.description,isFlight:!1};e.type===TravelType.Plane&&(a=this.extendContextForFlight(a,e)),t=this.dialogManager.travelDetailViewTemplate(a)}else{var n={arrivingDateTime:this.formatDate(i,e.useTime),leavingDateTime:this.formatDate(r,e.useTime),isFlight:!1};e.type===TravelType.Plane&&(n=this.extendContextForFlight(n,e)),t=this.dialogManager.travelDetailViewFriends(n)}var o=$(t);this.dialogManager.regClose(o),this.dialogManager.insertDialog(o)},t.prototype.createEdit=function(e){this.buildTemplateEdit(e),this.initTravelType(e.type),this.dialogManager.initDescription(e.description,TripEntityType.Travel),this.files=this.dialogManager.createFilesInstance(e.id,TripEntityType.Travel),this.files.setFiles(e.files,this.dialogManager.planner.trip.tripId,e.filesPublic),this.initAirport(e.flightFrom,"airportFrom","flightFrom"),this.initAirport(e.flightTo,"airportTo","flightTo")},t.prototype.initAirport=function(t,i,r){var a=this,n=new e.AirportCombo(i);n.onSelected=function(e){var t=a.dialogManager.getPropRequest(r,{id:e.id,name:e.name});a.dialogManager.updateProp(t,function(e){})},t&&n.setText(t.selectedName)},t.prototype.initTravelType=function(e){var t=this;this.showHideTravelDetails(e);var i=$("#travelType"),r=i.find("input");r.val(e);var a=i.find("li[data-value='"+e+"']"),n=a.data("cls"),o=a.data("cap");i.find(".selected").html('<span class="ticon '+n+' black"></span>    '+o),r.change(function(e){var a=parseInt(r.val());t.showHideTravelDetails(a);var n=t.dialogManager.getPropRequest("travelType",{travelType:a});t.dialogManager.updateProp(n,function(e){var t=i.find("li[data-value='"+a+"']"),r=t.data("cls");$(".active").find(".ticon").attr("class","ticon "+r)})})},t.prototype.showHideTravelDetails=function(e){var t=$("#flightDetails");t.hide(),e===TravelType.Plane&&t.show()},t.prototype.buildTemplateEdit=function(t){var i=$(this.dialogManager.travelDetailTemplate()),r=new e.PlaceTravelTime(this.dialogManager,t),a=r.create(TripEntityType.Travel);i.find(".the-first").after(a),Common.DropDown.registerDropDown(i.find(".dropdown")),this.dialogManager.regClose(i),this.dialogManager.insertDialog(i)},t}();e.TravelDialog=t}(Trip||(Trip={}));var Trip;!function(e){var t=function(){function e(){}return e.dateStringToUtcDate=function(e){var t=new Date(Date.parse(e)),i=6e4*t.getTimezoneOffset(),r=new Date(t.getTime()+i);return r},e.dateToUtcDate=function(e){var t=6e4*e.getTimezoneOffset(),i=new Date(e.getTime()-t),r=new Date(Date.UTC(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate()));return r},e}();e.Utils=t}(Trip||(Trip={}));var Trip;!function(e){var t=function(){function e(){}return e}();e.Place=t;var i=function(){function e(){}return e}();e.PlaceLocation=i;var r=function(){function e(){}return e}();e.Travel=r;var a=function(){function i(e){this.places=[],this.travels=[],this.tripId=e}return i.prototype.removePlaceById=function(e){this.places=_.reject(this.places,function(t){return t.id===e})},i.prototype.removeTravelById=function(e){this.travels=_.reject(this.travels,function(t){return t.id===e})},i.prototype.mapTravel=function(t,i,a){var n=new r;return n.id=t.id,n.type=t.type,n.arrivingDateTime=e.Utils.dateStringToUtcDate(t.arrivingDateTime),n.leavingDateTime=e.Utils.dateStringToUtcDate(t.leavingDateTime),n.from=i,n.to=a,n},i.prototype.mapPlace=function(e,i,r){var a=new t;return a.id=e.id,a.orderNo=e.orderNo,a.place=e.place,a.arriving=i,a.leaving=r,a},i.prototype.setData=function(e,t){var i=this;t.forEach(function(t){var r=i.mapPlace(t,null,null);t.arrivingId!==Constants.emptyId&&(r.arriving=i.getOrCreateTravelById(t.arrivingId,e),r.arriving.to=r),t.leavingId!==Constants.emptyId&&(r.leaving=i.getOrCreateTravelById(t.leavingId,e),r.leaving.from=r),i.places.push(r)})},i.prototype.getOrCreateTravelById=function(e,t){var i=_.find(this.travels,function(t){return t.id===e});if(i)return i;var r=_.find(t,function(t){return t.id===e}),a=this.mapTravel(r,null,null);return this.travels.push(a),a},i.prototype.getTravelById=function(e){return _.find(this.travels,function(t){return t.id===e})},i.prototype.getLastPlace=function(){var e=_.max(this.places,function(e){return e.orderNo});return e},i}();e.PlacesManager=a}(Trip||(Trip={}));